<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs">
    <?foreach WIXUIARCH in X86;X64;A64 ?>
    <Fragment>
        <UI Id="WixUI_CustomPlugin_$(WIXUIARCH)" />
        <UIRef Id="WixUI_CustomPlugin" />
    </Fragment>
    <?endforeach?>

    <?foreach WIXUIARCH in X86;X64;A64 ?>
    <Fragment>
        <UI Id="WixUI_CustomPlugin_ExtendedPathValidation_$(WIXUIARCH)" />
        <UIRef Id="WixUI_CustomPlugin" />
    </Fragment>
    <?endforeach?>

    <Fragment>

        <WixVariable Id="WixUISupportPerUser" Value="1" />
        <WixVariable Id="WixUISupportPerMachine" Value="1" />

        <Property Id="WixAppFolder" Value="{}" />

        <CustomAction Id="C_WixSetAppFolderPerUser" Property="WixAppFolder" Value="WixPerUserFolder" Execute="immediate" />
        <CustomAction Id="C_WixSetAppFolderPerMachine" Property="WixAppFolder" Value="WixPerMachineFolder" Execute="immediate" />
        <!-- or [WIXPERUSERAPPFOLDER]\[ApplicationFolderName] / [WIXPERMACHINEAPPFOLDER]\[ApplicationFolderName] -->
        <CustomAction Id="C_WixSetDefaultPerUserFolder" Property="WixPerUserFolder" Value="[WIXPERUSERAPPFOLDER]" Execute="immediate" />
        <CustomAction Id="C_WixSetDefaultPerMachineFolder" Property="WixPerMachineFolder" Value="[WIXPERMACHINEAPPFOLDER]" Execute="immediate" />
        <CustomAction Id="C_WixSetPerUserFolder" Property="APPLICATIONFOLDER" Value="[WixPerUserFolder]" Execute="immediate" />
        <CustomAction Id="C_WixSetPerMachineFolder" Property="APPLICATIONFOLDER" Value="[WixPerMachineFolder]" Execute="immediate" />
        <CustomAction Id="C_WixUnsetALLUSERS" Property="ALLUSERS" Value="{}" Execute="immediate" />
        <CustomAction Id="C_WixSetALLUSERS" Property="ALLUSERS" Value="1" Execute="immediate" />

        <?foreach WIXSEQ in UI;Execute ?>
        <?if $(WIXSEQ) = "UI" ?>
        <InstallUISequence>
        <?elseif $(WIXSEQ) = "Execute" ?>
        <InstallExecuteSequence>
        <?endif?>
            <Custom Action="C_WixSetAppFolderPerUser" Before="CostFinalize" Condition="NOT WIXPERUSERAPPFOLDER = &quot;&quot;" />
            <Custom Action="C_WixSetAppFolderPerMachine" After="C_WixSetAppFolderPerUser" Condition="NOT WIXPERMACHINEAPPFOLDER = &quot;&quot; AND WIXPERUSERAPPFOLDER = &quot;&quot;" />
            <Custom Action="C_WixSetDefaultPerUserFolder" After="C_WixSetAppFolderPerMachine" />
            <Custom Action="C_WixSetDefaultPerMachineFolder" After="C_WixSetDefaultPerUserFolder" />
            <Custom Action="C_WixSetPerUserFolder" After="C_WixSetDefaultPerMachineFolder" Condition="ACTION=&quot;INSTALL&quot; AND APPLICATIONFOLDER=&quot;&quot; AND WixAppFolder = &quot;WixPerUserFolder&quot;" />
            <Custom Action="C_WixSetPerMachineFolder" After="C_WixSetPerUserFolder" Condition="ACTION=&quot;INSTALL&quot; AND APPLICATIONFOLDER=&quot;&quot; AND WixAppFolder = &quot;WixPerMachineFolder&quot;" />
            <Custom Action="C_WixUnsetALLUSERS" After="C_WixSetPerMachineFolder" Condition="WixAppFolder = &quot;WixPerUserFolder&quot;" />
            <Custom Action="C_WixSetALLUSERS" After="C_WixUnsetALLUSERS" Condition="WixAppFolder = &quot;WixPerMachineFolder&quot;" />
        <?if $(WIXSEQ) = "Execute" ?>
        </InstallExecuteSequence>
        <?elseif $(WIXSEQ) = "UI" ?>
        </InstallUISequence>
        <?endif?>
        <?endforeach?>

        <UI Id="file WixUI_CustomPlugin">
            <TextStyle Id="WixUI_Font_Normal" FaceName="Tahoma" Size="8" />
            <TextStyle Id="WixUI_Font_Bigger" FaceName="Tahoma" Size="12" />
            <TextStyle Id="WixUI_Font_Title" FaceName="Tahoma" Size="9" Bold="yes" />

            <Property Id="DefaultUIFont" Value="WixUI_Font_Normal" />

            <DialogRef Id="BrowseDlg" />
            <DialogRef Id="DiskCostDlg" />
            <DialogRef Id="ErrorDlg" />
            <DialogRef Id="FatalError" />
            <DialogRef Id="FilesInUse" />
            <DialogRef Id="MsiRMFilesInUse" />
            <DialogRef Id="PrepareDlg" />
            <DialogRef Id="ProgressDlg" />
            <DialogRef Id="ResumeDlg" />
            <DialogRef Id="UserExit" />

            <Publish Dialog="ExitDialog" Control="Finish" Event="EndDialog" Value="Return" Order="999" />

            <Publish Dialog="WelcomeDlg" Control="Next" Event="NewDialog" Value="LicenseAgreementDlg" Condition="NOT Installed AND NOT &quot;!(wix.WixUILicenseRtf=)&quot; = &quot;&quot;" />
            <Publish Dialog="WelcomeDlg" Control="Next" Event="NewDialog" Value="InstallScopeDlg" Condition="NOT Installed AND &quot;!(wix.WixUILicenseRtf=)&quot; = &quot;&quot; AND NOT WIXPERMACHINEAPPFOLDER = &quot;&quot; AND NOT WIXPERUSERAPPFOLDER = &quot;&quot;" />
            <Publish Dialog="WelcomeDlg" Control="Next" Event="NewDialog" Value="VerifyReadyDlg" Condition="Installed AND PATCH OR NOT Installed AND &quot;!(wix.WixUILicenseRtf=)&quot; = &quot;&quot; AND (WIXPERMACHINEAPPFOLDER = &quot;&quot; OR WIXPERUSERAPPFOLDER = &quot;&quot;)" />

            <Publish Dialog="LicenseAgreementDlg" Control="Back" Event="NewDialog" Value="WelcomeDlg" />
            <Publish Dialog="LicenseAgreementDlg" Control="Next" Event="NewDialog" Value="InstallScopeDlg" Condition="LicenseAccepted = &quot;1&quot; AND NOT WIXPERMACHINEAPPFOLDER = &quot;&quot; AND NOT WIXPERUSERAPPFOLDER = &quot;&quot;" />
            <Publish Dialog="LicenseAgreementDlg" Control="Next" Event="NewDialog" Value="VerifyReadyDlg" Condition="LicenseAccepted = &quot;1&quot; AND (WIXPERMACHINEAPPFOLDER = &quot;&quot; OR WIXPERUSERAPPFOLDER = &quot;&quot;)" />

            <Publish Dialog="InstallScopeDlg" Control="Back" Event="NewDialog" Value="WelcomeDlg" Condition="&quot;!(wix.WixUILicenseRtf=)&quot; = &quot;&quot;" />
            <Publish Dialog="InstallScopeDlg" Control="Back" Event="NewDialog" Value="LicenseAgreementDlg" Condition="NOT &quot;!(wix.WixUILicenseRtf=)&quot; = &quot;&quot;" />
            <Publish Dialog="InstallScopeDlg" Control="Next" Property="ALLUSERS" Value="{}" Order="1" Condition="WixAppFolder = &quot;WixPerUserFolder&quot;" />
            <Publish Dialog="InstallScopeDlg" Control="Next" Property="ALLUSERS" Value="1" Order="2" Condition="WixAppFolder = &quot;WixPerMachineFolder&quot;" />
            <Publish Dialog="InstallScopeDlg" Control="Next" Property="APPLICATIONFOLDER" Value="[WixPerUserFolder]" Order="3" Condition="WixAppFolder = &quot;WixPerUserFolder&quot;" />
            <Publish Dialog="InstallScopeDlg" Control="Next" Property="APPLICATIONFOLDER" Value="[WixPerMachineFolder]" Order="4" Condition="WixAppFolder = &quot;WixPerMachineFolder&quot;" />
            <Publish Dialog="InstallScopeDlg" Control="Next" Event="SetTargetPath" Value="[WIXUI_INSTALLDIR]" Order="5" />
            <Publish Dialog="InstallScopeDlg" Control="Next" Event="NewDialog" Value="VerifyReadyDlg" Order="6" />

            <Publish Dialog="VerifyReadyDlg" Control="Back" Event="NewDialog" Value="MaintenanceTypeDlg" Order="2" Condition="Installed AND NOT PATCH" />
            <Publish Dialog="VerifyReadyDlg" Control="Back" Event="NewDialog" Value="WelcomeDlg" Order="2" Condition="Installed AND PATCH OR NOT Installed AND (WIXPERMACHINEAPPFOLDER = &quot;&quot; OR WIXPERUSERAPPFOLDER = &quot;&quot;) AND &quot;!(wix.WixUILicenseRtf=)&quot; = &quot;&quot;" />
            <Publish Dialog="VerifyReadyDlg" Control="Back" Event="NewDialog" Value="InstallScopeDlg" Order="1" Condition="NOT Installed AND NOT WIXPERMACHINEAPPFOLDER = &quot;&quot; AND NOT WIXPERUSERAPPFOLDER = &quot;&quot;" />
            <Publish Dialog="VerifyReadyDlg" Control="Back" Event="NewDialog" Value="LicenseAgreementDlg" Order="1" Condition="NOT Installed AND (WIXPERMACHINEAPPFOLDER = &quot;&quot; OR WIXPERUSERAPPFOLDER = &quot;&quot;) AND NOT &quot;!(wix.WixUILicenseRtf=)&quot; = &quot;&quot;" />

            <Publish Dialog="MaintenanceWelcomeDlg" Control="Next" Event="NewDialog" Value="MaintenanceTypeDlg" />

            <Publish Dialog="MaintenanceTypeDlg" Control="RepairButton" Event="NewDialog" Value="VerifyReadyDlg" />
            <Publish Dialog="MaintenanceTypeDlg" Control="RemoveButton" Event="NewDialog" Value="VerifyReadyDlg" />
            <Publish Dialog="MaintenanceTypeDlg" Control="Back" Event="NewDialog" Value="MaintenanceWelcomeDlg" />

            <Property Id="ARPNOMODIFY" Value="1" />
        </UI>

        <UIRef Id="WixUI_Common" />
    </Fragment>
</Wix>
